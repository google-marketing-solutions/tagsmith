<!--
 * Copyright 2023 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 -->

<!-- Tagsmith, Debugger, v1.0.0 -->
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20,400,0,0" />
<style>
.__tagsmith_debugger_icon {
  background: center no-repeat url("data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8' standalone='no'%3F%3E%3C!DOCTYPE svg PUBLIC '-//W3C//DTD SVG 1.1//EN' 'http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd'%3E%3Csvg width='100%25' height='100%25' viewBox='0 0 512 512' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' xml:space='preserve' xmlns:serif='http://www.serif.com/' style='fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;'%3E%3Cg transform='matrix(0.707107,-0.707107,0.707107,0.707107,-135.505,226.533)'%3E%3Cpath id='base' d='M404,170.352C404,159.213 399.575,148.53 391.698,140.653C368.601,117.556 318.154,67.108 285.698,34.653C269.296,18.251 242.704,18.251 226.302,34.653C193.846,67.108 143.399,117.556 120.302,140.653C112.425,148.53 108,159.213 108,170.352C108,220.899 108,368.788 108,441.963C108,453.102 112.425,463.785 120.302,471.662C128.178,479.538 138.861,483.963 150,483.963C206.309,483.963 305.691,483.963 362,483.963C373.139,483.963 383.822,479.538 391.698,471.662C399.575,463.785 404,453.102 404,441.963C404,368.788 404,220.899 404,170.352ZM256,78C273.661,78 288,92.339 288,110C288,127.661 273.661,142 256,142C238.339,142 224,127.661 224,110C224,92.339 238.339,78 256,78Z' style='fill:rgb(68,34,98);'/%3E%3Cg id='flame' transform='matrix(0.994924,0,0,0.841367,1.139,76.3033)'%3E%3Cpath d='M404.916,362.263C404.916,360.032 403.604,358.101 401.761,357.621C399.919,357.14 398.041,358.24 397.248,360.264C395.018,365.955 392.645,372.01 390.643,377.118C387.702,384.624 381.342,389.427 374.347,389.427C374.347,389.427 374.347,389.427 374.346,389.427C367.452,389.427 361.391,384.029 359.488,376.192C353.921,353.263 342.537,306.379 336.887,283.112C334.914,274.984 328.627,269.385 321.476,269.385C321.476,269.385 321.476,269.385 321.475,269.385C314.258,269.385 307.825,274.767 305.423,282.815C300.108,300.624 290.705,332.128 284.742,352.104C281.468,363.075 272.7,370.411 262.862,370.411C262.861,370.411 262.861,370.411 262.861,370.411C256.886,370.411 251.402,366.499 248.615,360.248C243.462,348.694 235.051,329.829 229.52,317.424C226.124,309.808 219.441,305.041 212.159,305.041L212.158,305.041C202.36,305.041 193.6,312.257 190.203,323.123C182.801,346.805 169.971,387.85 163.195,409.527C160.496,418.162 153.535,423.895 145.75,423.895C145.75,423.895 145.75,423.895 145.749,423.895C137.242,423.895 129.675,417.504 126.916,407.988C123.615,396.602 119.091,380.997 115.23,367.68C114.592,365.482 112.704,364.151 110.766,364.533C108.827,364.915 107.406,366.898 107.406,369.222C107.406,387.871 107.406,412.737 107.406,434.602C107.406,447.841 111.854,460.538 119.77,469.9C127.687,479.261 138.425,484.521 149.62,484.521C206.217,484.521 306.106,484.521 362.702,484.521C373.898,484.521 384.635,479.261 392.552,469.9C400.469,460.538 404.916,447.841 404.916,434.602C404.916,409.886 404.916,381.334 404.916,362.263Z' style='fill:rgb(251,188,4);'/%3E%3C/g%3E%3Cg id='tag' transform='matrix(-0.505076,-0.505076,0.505076,-0.505076,266.607,485.358)'%3E%3Cpath d='M404,133.8L180,133.8C166.082,133.8 154.8,145.082 154.8,159L154.8,383C154.8,396.908 166.092,408.2 180,408.2C193.908,408.2 205.2,396.908 205.2,383L205.2,184.2C205.2,184.2 404,184.2 404,184.2C417.908,184.2 429.2,172.908 429.2,159C429.2,145.092 417.908,133.8 404,133.8Z' style='fill:rgb(254,247,224);'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E%0A");
}

.__tagsmith_debugger_open {
  position: fixed;
  bottom: 20px;
  left: 20px;
  width: 50px;
  height: 50px;
  box-sizing: border-box;
  background-size: 32px;
  background-color: #F1F3F4;
  border-radius: 50%;
  box-shadow:
    rgba(0, 0, 0, 0.2) 0px 3px 5px -1px,
    rgba(0, 0, 0, 0.14) 0px 5px 8px 0px,
    rgba(0, 0, 0, 0.12) 0px 1px 14px 0px;
  z-index: 2147483648;
  cursor: pointer;
}

.__tagsmith_debugger_open:hover {
  background-color: #FEF7E0;
}

.__tagsmith_debugger_container {
  position: fixed;
  left: 0;
  right: 0;
  top: 0;
  bottom: 0;
  z-index: 2147483648;
  background: rgba(0, 0, 0, 0.5);
  padding: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  visibility: hidden;
}

.__tagsmith_debugger_popup {
  overflow: hidden;
  display: flex;
  flex-direction: column;
  font-family: Helvetica Neue,Helvetica,Arial,sans-serif;
  font-size: 10px;
  line-height: 1.3;
  min-width: 335px;
  max-height: 100%;
  background: #FFF;
  border-radius: 8px;
  box-shadow:
    rgba(0, 0, 0, 0.2) 0px 3px 5px -1px,
    rgba(0, 0, 0, 0.14) 0px 5px 8px 0px,
    rgba(0, 0, 0, 0.12) 0px 1px 14px 0px;
}

.__tagsmith_debugger_header {
  flex: 0 0;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 6px 12px;
  font-size: 1.4em;
  font-weight: bold;
  color: #202124;
  background: #F1F3F4;
}

.__tagsmith_debugger_header .__tagsmith_debugger_icon {
  width: 32px;
  height: 32px;
}

.__tagsmith_debugger_actions {
  display: flex;
}

.__tagsmith_debugger_action_item {
  font-family: Material Symbols Outlined;
  font-size: 18px;
  text-align: center;
  line-height: 40px;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  cursor: pointer;
}

.__tagsmith_debugger_action_item:hover {
  background: #DADCE0;
}

.__tagsmith_debugger_more {
  position: relative;
}

.__tagsmith_debugger_menu {
  display: none;
  position: absolute;
  right: 0;
  top: 40px;
  overflow: hidden;
  background: #FFF;
  border-radius: 8px;
  box-shadow:
    rgba(0, 0, 0, 0.2) 0px 3px 5px -1px,
    rgba(0, 0, 0, 0.14) 0px 5px 8px 0px,
    rgba(0, 0, 0, 0.12) 0px 1px 14px 0px;
}

.__tagsmith_debugger_more:focus > .__tagsmith_debugger_menu {
  display: block;
}

.__tagsmith_debugger_menu_item {
  padding: 6px 12px;
  font-weight: normal;
  cursor: pointer;
  white-space: nowrap;
}

.__tagsmith_debugger_menu_item:hover {
  background: #FEF7E0;
}

.__tagsmith_debugger_body {
  overflow: auto;
  display: flex;
  flex-direction: column;
  gap: 12px;
  padding: 12px;
  font-size: 1.4em;
}

.__tagsmith_debugger_body > * {
  padding-bottom: 12px;
  border-bottom: #9AA0A6 1px dashed;
}

.__tagsmith_debugger_body > *:last-child {
  padding-bottom: none;
  border-bottom: none;
}

.__tagsmith_debugger_sectionTitle {
  padding: 6px 0;
  font-weight: bold;
}

#__tagsmith_debugger_errors {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.__tagsmith_debugger_error {
  display: flex;
  align-items: center;
  color: #D93025;
}

.__tagsmith_debugger_error::before {
  content: "error";
  margin-right: 6px;
  font-family: Material Symbols Outlined;
  font-size: 20px;
}

#__tagsmith_debugger_featuresForAll {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
}

#__tagsmith_debugger_featuresForAll > * {
  margin: 0;
}

.__tagsmith_debugger_table {
  flex-grow: 1;
  border-collapse: collapse;
}

.__tagsmith_debugger_table th,
.__tagsmith_debugger_table td {
  white-space: nowrap;
  padding: 6px 12px;
}

.__tagsmith_debugger_table td {
  border: #9AA0A6 1px solid;
}

.__tagsmith_debugger_testName {
  width: 64px;
  font-weight: bold;
  background: #E8EAED;
}

.__tagsmith_debugger_variant {
  position: relative;
  width: 64px;
  background: #F8F9FA;
}

.__tagsmith_debugger_variant:not(.active) {
  cursor: pointer;
}

.__tagsmith_debugger_variant::before {
  position: absolute;
  top: 0;
  right: 4px;
  font-family: Material Symbols Outlined;
  font-size: 24px;
}

.__tagsmith_debugger_variant::before {
  content: "toggle_off";
  color: #9AA0A6;
}

.__tagsmith_debugger_variant.active::before,
.__tagsmith_debugger_variant:hover::before {
  content: "toggle_on";
  color: #34A853;
}

.__tagsmith_debugger_percentage {
  display: block;
  width: min-content;
  margin-bottom: 3px;
  padding: 0 6px;
  border-radius: 50vh;
  font-weight: normal;
  background: #FFF;
  border: #9AA0A6 1px solid;
}

.__tagsmith_debugger_feature,
.__tagsmith_debugger_logger {
  display: inline-block;
  margin-right: 6px;
  padding: 6px 12px;
  border-radius: 50vh;
  color: #FFF;
}

.__tagsmith_debugger_feature:last-child,
.__tagsmith_debugger_logger:last-child {
  margin-right: 0;
}

.__tagsmith_debugger_feature {
  background: #34A853;
}

.__tagsmith_debugger_logger {
  background: #4285F4;
}
</style>
<div id="__tagsmith_debugger">
  <div class="__tagsmith_debugger_open __tagsmith_debugger_icon"></div>
  <div class="__tagsmith_debugger_container">
    <div class="__tagsmith_debugger_popup">
      <div class="__tagsmith_debugger_header">
        <div class="__tagsmith_debugger_icon"></div>
        Tagsmith Debugger
        <div class="__tagsmith_debugger_actions">
          <div tabindex="1" class="__tagsmith_debugger_more">
            <div class="__tagsmith_debugger_action_item">more_horiz</div>
            <div class="__tagsmith_debugger_menu">
              <div id="__tagsmith_debugger_test_setup" class="__tagsmith_debugger_menu_item">Test setup</div>
            </div>
          </div>
          <div class="__tagsmith_debugger_action_item __tagsmith_debugger_close">close</div>
        </div>
      </div>
      <div class="__tagsmith_debugger_body">
        <div>
          <div class="__tagsmith_debugger_sectionTitle">Errors</div>
          <div id="__tagsmith_debugger_errors"></div>
        </div>
        <div>
          <div class="__tagsmith_debugger_sectionTitle">Featured enabled for all users</div>
          <div id="__tagsmith_debugger_featuresForAll"></div>
        </div>
        <table class="__tagsmith_debugger_table">
          <thead>
            <tr>
              <th>Test</th>
              <th>Variant</th>
              <th>Feature Enabled</th>
              <th>Loggers Enabled</th>
            </tr>
          </thead>
          <tbody id="__tagsmith_debugger_testStatus"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>
<script>
(function(w, o) {
  var LOCAL_STORAGE_KEY = '__tagsmith_ab_factor';
  var DEBUG = w[o].__debug();

  var errors = [];

  /** @type {!Array<{
   *   name: string,
   *   percentage: number,
   *   variants: !Array<{
   *     name: string,
   *     percentage: number,
   *     leftBoundary: number
   *   }
   * }}
   */
  var abStatus = [];
  /** @type {!Array<string>} */
  var validVariants = [];

  for (var i = 0; i < DEBUG.AB_CONF.length; i++) {
    var testConf = DEBUG.AB_CONF[i];
    var lastTestConf = i === 0 ? null : DEBUG.AB_CONF[i - 1];

    var leftBoundary = lastTestConf ? lastTestConf[lastTestConf.length - 1] : 0;

    var test = {
      name: testConf[0],
      percentage: testConf[testConf.length - 1] - leftBoundary,
      variants: []
    };
    abStatus.push(test);

    for (var j = 1; j < testConf.length; j++) {
      var isControlVariant = j === 1;
      var rightBoundary = testConf[j];

      var variant = {
        name: test.name + '_' + (isControlVariant ? 'con' : 'exp' + (j - 1)),
        percentage: rightBoundary - leftBoundary,
        leftBoundary: leftBoundary
      };
      test.variants.push(variant);

      leftBoundary = rightBoundary;

      if (!isControlVariant) {
        validVariants.push(variant.name);
      }
    }
  }

  var featuresForAll = [];
  var featureByVariant = {};

  var originalEnableFunc = w[o].enable;
  /**
   * Try enabling a feature for a specific variant.
   * This debugger version provides the same feature as original but records
   * all features enabled and logs any potential errors.
   * @param {string} feature
   * @param {string} forVariant
   * @return {boolean} `true` if the feature should be enabled for current user.
   */
  w[o].enable = function(feature, forVariant) {
    if (forVariant === 'all') {
      featuresForAll.push(feature);
    } else if (validVariants.indexOf(forVariant) === -1) {
      errors.push(forVariant + ' is not valid.');
    } else if (featureByVariant[forVariant]) {
      errors.push(
          forVariant + ' already used by ' + featureByVariant[forVariant]
      );
    } else {
      featureByVariant[forVariant] = feature;
    }

    return originalEnableFunc(feature, forVariant);
  };

  /** @type {!Object<string, !Array<string>>} */
  var loggersEnabledByTest = {};

  var originalGetLoggerFunc = w[o].getLogger;

  /** @typedef {function(string, string): void} */
  // eslint-disable-next-line no-unused-vars
  var Logger;

  /**
   * Get logger for feature on a specific variant.
   * This debugger version provides the same feature as original but records
   * all features enabled and logs any potential errors.
   * @param {string} feature
   * @param {string} forVariant
   * @return {!Logger|false} `false` when logger shouldn't be enabled.
   */
  w[o].getLogger = function(feature, forVariant) {
    if (forVariant !== 'all') {
      var forTestName = forVariant.substr(0, forVariant.lastIndexOf('_'));
      loggersEnabledByTest[forTestName] =
        loggersEnabledByTest[forTestName] || [];
      if (loggersEnabledByTest[forTestName].indexOf(feature) === -1) {
        loggersEnabledByTest[forTestName].push(feature);
      }
    }

    return originalGetLoggerFunc(feature, forVariant);
  };

  /**
   * Assign current user to a specific variant.
   * @param {string} variant
   */
  var activateVariant = function(variant) {
    if (!confirm('Assign current user to variant "' + variant.name + '"?')) {
      return;
    }

    localStorage.setItem(LOCAL_STORAGE_KEY, variant.leftBoundary.toString());

    alert('Assigned. Refreshing pageâ€¦');
    window.location.reload();
  };

  // #region UI implementations

  var $root = document.getElementById('__tagsmith_debugger');
  var $open = $root.querySelector('.__tagsmith_debugger_open');
  var $container = $root.querySelector('.__tagsmith_debugger_container');
  var $testSetup = $root.querySelector('#__tagsmith_debugger_test_setup');
  var $close = $root.querySelector('.__tagsmith_debugger_close');

  var testSetupLogger;

  /**
   * Test framework setup.
   */
  var testSetup = function() {
    var userVariant = w[o].userVariant();

    if (!testSetupLogger) {
      testSetupLogger = w[o].getLogger('debugger', userVariant);
    }

    if (testSetupLogger) {
      var eventName = 'testEventName';
      var eventValue = 'testEventValue';
      testSetupLogger(eventName, eventValue);
      alert('Event sent with name: ' + eventName + ', value: ' + eventValue);
    } else {
      alert('Can\'t get logger for debugger.');
    }
  };

  $testSetup.addEventListener('click', testSetup);

  /**
   * Refresh all UI elements.
   */
  var refresh = function() {
    refreshErrors();
    refreshFeaturesForAll();
    refreshAbStatus();
  };

  var $errors = $root.querySelector('#__tagsmith_debugger_errors');

  /**
   * Refresh errors.
   */
  var refreshErrors = function() {
    $errors.innerText = '';

    if (errors.length === 0) {
      $errors.innerText = 'None';
      return;
    }

    for (var i = 0; i < errors.length; i++) {
      var error = errors[i];
      var $error = document.createElement('div');
      $error.className = '__tagsmith_debugger_error';
      $error.innerText = error;
      $errors.append($error);
    }
  };

  var $featuresForAll = $root.querySelector(
      '#__tagsmith_debugger_featuresForAll'
  );

  /**
   * Refresh features enabled for all users.
   */
  var refreshFeaturesForAll = function() {
    $featuresForAll.innerText = '';

    if (featuresForAll.length === 0) {
      $featuresForAll.innerText = 'None';
      return;
    }

    for (var i = 0; i < featuresForAll.length; i++) {
      var $feature = document.createElement('div');
      $feature.className = '__tagsmith_debugger_feature';
      $feature.innerText = featuresForAll[i];
      $featuresForAll.append($feature);
    }
  };

  var $testStatus = $root.querySelector('#__tagsmith_debugger_testStatus');

  /**
   * Refresh features and loggers enabled for each variant.
   */
  var refreshAbStatus = function() {
    var userVariant = w[o].userVariant();

    $testStatus.innerText = '';

    for (var i = 0; i < abStatus.length; i++) {
      var test = abStatus[i];

      var $testName = document.createElement('td');
      $testName.className = '__tagsmith_debugger_testName';
      $testName.rowSpan = test.variants.length;
      $testName.innerText = test.name;

      var $testPercentage = document.createElement('div');
      $testPercentage.className = '__tagsmith_debugger_percentage';
      $testPercentage.innerText = (test.percentage * 100).toFixed(2) + '%';
      $testName.prepend($testPercentage);

      for (var j = 0; j < test.variants.length; j++) {
        var variant = test.variants[j];

        var $tr = document.createElement('tr');
        $testStatus.append($tr);

        if (j === 0) {
          $tr.append($testName);
        }

        var $variant = document.createElement('td');
        $variant.className = '__tagsmith_debugger_variant';
        $variant.innerText = variant.name;
        $tr.append($variant);

        if (variant.name === userVariant) {
          $variant.classList.add('active');
        } else {
          $variant.addEventListener(
              'click',
              activateVariant.bind(null, variant)
          );
        }

        var $variantPercentage = document.createElement('div');
        $variantPercentage.className = '__tagsmith_debugger_percentage';
        $variantPercentage.innerText =
          (variant.percentage * 100).toFixed(2) + '%';
        $variant.prepend($variantPercentage);

        var $featureEnabled = document.createElement('td');
        $tr.append($featureEnabled);

        if (featureByVariant[variant.name]) {
          var $feature = document.createElement('div');
          $feature.className = '__tagsmith_debugger_feature';
          $feature.innerText = featureByVariant[variant.name];
          $featureEnabled.append($feature);
        }

        var $loggersEnabled = document.createElement('td');
        $tr.append($loggersEnabled);

        if (loggersEnabledByTest[test.name]) {
          var loggers = loggersEnabledByTest[test.name];

          for (var k = 0; k < loggers.length; k++) {
            var $logger = document.createElement('div');
            $logger.className = '__tagsmith_debugger_logger';
            $logger.innerText = loggers[k];
            $loggersEnabled.append($logger);
          }
        }
      }
    }
  };

  $open.addEventListener('click', function() {
    $container.style.visibility = 'visible';

    refresh();
  });

  $close.addEventListener('click', function() {
    $container.style.visibility = 'hidden';
  });

  // #endregion
})(window, '__tagsmith');
</script>
